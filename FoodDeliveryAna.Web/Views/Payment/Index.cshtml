@{
    ViewData["Title"] = "Payment";
}
<h2>Payment</h2>
<p>Enter an amount to test (in major units, e.g. 12 for $12):</p>
<input id="amount" type="number" value="10" min="1" step="1" />
<button id="payBtn">Create Payment</button>
<div id="message" style="margin-top:10px;"></div>
<div id="payment-element" style="margin-top:14px;"></div>
<button id="confirmBtn" style="display:none;margin-top:10px;">Confirm</button>

<script src="https://js.stripe.com/v3/"></script>
<script>
const payBtn = document.getElementById('payBtn');
const confirmBtn = document.getElementById('confirmBtn');
const message = document.getElementById('message');
let stripe, elements;

payBtn.addEventListener('click', async () => {
    const amount = parseInt(document.getElementById('amount').value || '10', 10);
    const res = await fetch('/api/payment/charge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount, currency: 'usd', description: 'Order payment' })
    });
    const data = await res.json();
    if (data.error) {
        message.textContent = data.error;
        return;
    }
    stripe = Stripe(data.publishableKey);
    const options = { clientSecret: data.clientSecret };
    elements = stripe.elements(options);
    const paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');
    confirmBtn.style.display = 'inline-block';
});

confirmBtn.addEventListener('click', async () => {
    const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: { return_url: window.location.origin + '/Payment/Success' },
        redirect: 'if_required'
    });
    if (error) message.textContent = error.message;
    else message.textContent = 'Payment processing...';
});
</script>
