@model FoodDeliveryAna.Domain.DomainModels.ShoppingCart
@{ ViewData["Title"] = "Checkout"; decimal total = Model.Items.Sum(i => (i.MenuItem?.Price ?? 0) * i.Quantity); var publishable = ViewBag.StripePublishableKey as string; }
<h1 class="h4 fw-semibold mb-3">Checkout</h1>
<div class="row g-4">
  <div class="col-lg-7">
    <div class="payment-panel p-4">
      <h2 class="h5 mb-3">Payment</h2>
      <form id="payment-form" asp-action="CheckoutConfirm" method="post">
        <div id="stripe-block" class="mb-3" data-publishable="@publishable">
          <div id="card-element" class="form-control"></div>
          <div id="card-errors" class="text-danger small mt-2" role="alert"></div>
        </div>
        <div id="demo-block" class="mb-3" style="display:none;">
          <div class="mb-2">
            <label class="form-label">Card number</label>
            <input type="text" class="form-control" value="4242 4242 4242 4242" readonly />
          </div>
          <div class="row g-2">
            <div class="col"><label class="form-label">Expiration</label><input type="text" class="form-control" value="12/34" readonly /></div>
            <div class="col"><label class="form-label">CVC</label><input type="text" class="form-control" value="123" readonly /></div>
          </div>
        </div>
        <button id="pay-btn" class="btn btn-primary btn-pill w-100">Pay @total.ToString("C")</button>
      </form>
      <p class="text-muted small mt-3">Test mode. No real payment is processed.</p>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card p-3">
      <h2 class="h6">Order summary</h2>
      <ul class="list-unstyled">
        @foreach (var i in Model.Items)
        {
          <li class="d-flex justify-content-between small my-2">
            <span>@i.MenuItem?.Name Ã— @i.Quantity</span>
            <span>@((i.MenuItem?.Price ?? 0) * i.Quantity).ToString("C")</span>
          </li>
        }
      </ul>
      <hr/>
      <div class="d-flex justify-content-between fw-semibold">
        <span>Total</span><span>@total.ToString("C")</span>
      </div>
    </div>
  </div>
</div>

@section Scripts{
<script src="https://js.stripe.com/v3/"></script>
<script>
(function(){{
  const publishable = document.getElementById('stripe-block').dataset.publishable;
  const demo = document.getElementById('demo-block');
  if(!publishable || publishable.length < 8){{
    // fallback to demo UI
    demo.style.display = 'block';
    document.getElementById('card-element').style.display = 'none';
    return;
  }}
  const stripe = Stripe(publishable);
  const elements = stripe.elements({{locale:'auto'}});
  const card = elements.create('card', {{ hidePostalCode: true }});
  card.mount('#card-element');
  card.on('change', function(event) {{
    const displayError = document.getElementById('card-errors');
    displayError.textContent = event.error ? event.error.message : '';
  }});
  const form = document.getElementById('payment-form');
  form.addEventListener('submit', async function(e){{
    e.preventDefault();
    const {{paymentMethod, error}} = await stripe.createPaymentMethod({{
      type: 'card', card: card
    }});
    if(error){{ document.getElementById('card-errors').textContent = error.message; return; }}
    // Append the payment method id so server can process if implemented
    const input = document.createElement('input');
    input.type='hidden'; input.name='stripePaymentMethodId'; input.value=paymentMethod.id;
    form.appendChild(input);
    form.submit();
  }});
}})();
</script>
}
